{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/primadi/lokstra/main/schema/lokstra.json",
  "title": "Lokstra Configuration Schema",
  "description": "JSON Schema for Lokstra framework YAML configuration files",
  "type": "object",
  "properties": {
    "server": {
      "$ref": "#/definitions/ServerConfig"
    },
    "apps": {
      "type": "array",
      "description": "List of applications to run",
      "items": {
        "$ref": "#/definitions/AppConfig"
      }
    },
    "services": {
      "type": "array",
      "description": "List of services to create and configure",
      "items": {
        "$ref": "#/definitions/ServiceConfig"
      }
    },
    "modules": {
      "type": "array",
      "description": "List of modules to load",
      "items": {
        "$ref": "#/definitions/ModuleConfig"
      }
    }
  },
  "additionalProperties": false,
  "definitions": {
    "ServerConfig": {
      "type": "object",
      "description": "Server-level configuration",
      "properties": {
        "name": {
          "type": "string",
          "description": "Name of the server instance",
          "default": "default"
        },
        "global_setting": {
          "type": "object",
          "description": "Global settings for the server",
          "properties": {
            "log_level": {
              "type": "string",
              "enum": ["trace", "debug", "info", "warn", "error", "fatal", "panic"],
              "description": "Global log level"
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "AppConfig": {
      "type": "object",
      "description": "Application configuration",
      "required": ["name", "address"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique name for the application"
        },
        "address": {
          "type": "string",
          "description": "Address to bind to (e.g., ':8080', 'localhost:3000', 'unix:///tmp/app.sock')",
          "examples": [":8080", "localhost:3000", "unix:///tmp/app.sock"]
        },
        "listener_type": {
          "type": "string",
          "description": "Type of HTTP listener to use",
          "enum": ["default", "nethttp", "fasthttp", "http3", "secure"],
          "default": "default"
        },
        "router_engine_type": {
          "type": "string",
          "description": "Type of router engine to use", 
          "enum": ["default", "httprouter", "servemux", "gin", "chi"],
          "default": "default"
        },
        "setting": {
          "type": "object",
          "description": "Application-specific settings",
          "additionalProperties": true
        },
        "groups": {
          "type": "array",
          "description": "Route groups with prefixes and middleware",
          "items": {
            "$ref": "#/definitions/GroupConfig"
          }
        },
        "routes": {
          "type": "array",
          "description": "Direct routes on the application",
          "items": {
            "$ref": "#/definitions/RouteConfig"
          }
        },
        "middleware": {
          "$ref": "#/definitions/MiddlewareList"
        },
        "mount_static": {
          "type": "array",
          "description": "Static file mount points",
          "items": {
            "$ref": "#/definitions/MountStaticConfig"
          }
        },
        "mount_spa": {
          "type": "array",
          "description": "Single Page Application mount points",
          "items": {
            "$ref": "#/definitions/MountSPAConfig"
          }
        },
        "mount_reverse_proxy": {
          "type": "array",
          "description": "Reverse proxy mount points",
          "items": {
            "$ref": "#/definitions/MountReverseProxyConfig"
          }
        }
      },
      "additionalProperties": false
    },
    "GroupConfig": {
      "type": "object",
      "description": "Route group configuration with prefix and nested routes",
      "required": ["prefix"],
      "properties": {
        "prefix": {
          "type": "string",
          "description": "URL prefix for this group (e.g., '/api', '/v1')",
          "pattern": "^/.*"
        },
        "groups": {
          "type": "array",
          "description": "Nested route groups",
          "items": {
            "$ref": "#/definitions/GroupConfig"
          }
        },
        "routes": {
          "type": "array",
          "description": "Routes within this group",
          "items": {
            "$ref": "#/definitions/RouteConfig"
          }
        },
        "load_from": {
          "type": "array",
          "description": "Load group configuration from external files",
          "items": {
            "type": "string"
          }
        },
        "middleware": {
          "$ref": "#/definitions/MiddlewareList"
        },
        "override_middleware": {
          "type": "boolean",
          "description": "Whether to override parent middleware",
          "default": false
        },
        "mount_static": {
          "type": "array",
          "description": "Static file mount points for this group",
          "items": {
            "$ref": "#/definitions/MountStaticConfig"
          }
        },
        "mount_spa": {
          "type": "array",
          "description": "SPA mount points for this group",
          "items": {
            "$ref": "#/definitions/MountSPAConfig"
          }
        },
        "mount_reverse_proxy": {
          "type": "array",
          "description": "Reverse proxy mount points for this group",
          "items": {
            "$ref": "#/definitions/MountReverseProxyConfig"
          }
        },
        "mount_rpc_service": {
          "type": "array",
          "description": "RPC service mount points for this group",
          "items": {
            "$ref": "#/definitions/MountRpcServiceConfig"
          }
        }
      },
      "additionalProperties": false
    },
    "RouteConfig": {
      "type": "object",
      "description": "Individual route configuration",
      "required": ["method", "path", "handler"],
      "properties": {
        "method": {
          "type": "string",
          "description": "HTTP method",
          "enum": ["GET", "POST", "PUT", "DELETE", "PATCH", "HEAD", "OPTIONS", "TRACE", "CONNECT"]
        },
        "path": {
          "type": "string",
          "description": "Route path pattern (e.g., '/users/:id', '/health')"
        },
        "handler": {
          "type": "string",
          "description": "Handler name to execute for this route (e.g., 'user.profile', 'health.check')"
        },
        "override_middleware": {
          "type": "boolean",
          "description": "Whether to override parent middleware",
          "default": false
        },
        "middleware": {
          "$ref": "#/definitions/MiddlewareList"
        }
      },
      "additionalProperties": false
    },
    "MiddlewareList": {
      "oneOf": [
        {
          "type": "array",
          "description": "List of middleware configurations",
          "items": {
            "oneOf": [
              {
                "type": "string",
                "description": "Middleware name (shorthand)"
              },
              {
                "$ref": "#/definitions/MiddlewareConfig"
              }
            ]
          }
        },
        {
          "type": "string",
          "description": "Single middleware name"
        },
        {
          "$ref": "#/definitions/MiddlewareConfig"
        }
      ]
    },
    "MiddlewareConfig": {
      "type": "object",
      "description": "Middleware configuration",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Name of the middleware",
          "examples": ["auth", "cors", "logger", "recovery", "rate_limit"]
        },
        "enabled": {
          "type": "boolean",
          "description": "Whether this middleware is enabled",
          "default": true
        },
        "config": {
          "type": "object",
          "description": "Middleware-specific configuration",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "ServiceConfig": {
      "type": "object",
      "description": "Service configuration",
      "required": ["name", "type"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique service instance name"
        },
        "type": {
          "type": "string",
          "description": "Service factory type",
          "examples": ["lokstra.logger", "lokstra.dbpool.pg", "lokstra.redis", "lokstra.jwt_auth"]
        },
        "config": {
          "type": "object",
          "description": "Service-specific configuration",
          "additionalProperties": true
        },
        "depends_on": {
          "type": "array",
          "description": "List of service names this service depends on",
          "items": {
            "type": "string"
          }
        }
      },
      "additionalProperties": false
    },
    "ModuleConfig": {
      "type": "object",
      "description": "Module configuration for loading external modules",
      "required": ["name", "path"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique module name"
        },
        "path": {
          "type": "string",
          "description": "Path to the module file (e.g., './plugins/user_module.so')"
        },
        "entry": {
          "type": "string",
          "description": "Entry point function name in the module"
        },
        "settings": {
          "type": "object",
          "description": "Module-specific settings",
          "additionalProperties": true
        },
        "permissions": {
          "type": "object",
          "description": "Module permissions configuration",
          "additionalProperties": true
        },
        "required_services": {
          "type": "array",
          "description": "List of service names required by this module",
          "items": {
            "type": "string"
          }
        },
        "create_services": {
          "type": "array",
          "description": "Services to be created by this module",
          "items": {
            "$ref": "#/definitions/ServiceConfig"
          }
        },
        "register_service_factories": {
          "type": "array",
          "description": "Service factory method names to register",
          "items": {
            "type": "string"
          }
        },
        "register_handlers": {
          "type": "array",
          "description": "Handler method names to register",
          "items": {
            "type": "string"
          }
        },
        "register_middleware": {
          "type": "array",
          "description": "Middleware method names to register",
          "items": {
            "type": "string"
          }
        }
      },
      "additionalProperties": false
    },
    "MountStaticConfig": {
      "type": "object",
      "description": "Static file serving configuration",
      "required": ["prefix", "folder"],
      "properties": {
        "prefix": {
          "type": "string",
          "description": "URL prefix to serve static files from (e.g., '/static', '/assets')",
          "pattern": "^/.*"
        },
        "folder": {
          "type": "string",
          "description": "Local folder path to serve files from (e.g., './static', './public')"
        }
      },
      "additionalProperties": false
    },
    "MountSPAConfig": {
      "type": "object",
      "description": "Single Page Application serving configuration",
      "required": ["prefix", "fallback_file"],
      "properties": {
        "prefix": {
          "type": "string",
          "description": "URL prefix for SPA routes (typically '/')",
          "pattern": "^/.*"
        },
        "fallback_file": {
          "type": "string",
          "description": "Fallback HTML file for client-side routing (e.g., './dist/index.html')"
        }
      },
      "additionalProperties": false
    },
    "MountReverseProxyConfig": {
      "type": "object",
      "description": "Reverse proxy configuration",
      "required": ["prefix", "target"],
      "properties": {
        "prefix": {
          "type": "string",
          "description": "URL prefix to proxy (e.g., '/api', '/external')",
          "pattern": "^/.*"
        },
        "target": {
          "type": "string",
          "description": "Target URL to proxy requests to (e.g., 'http://localhost:3000', 'https://api.example.com')",
          "format": "uri"
        }
      },
      "additionalProperties": false
    },
    "MountRpcServiceConfig": {
      "type": "object",
      "description": "RPC service mount configuration",
      "required": ["base_path", "service_name"],
      "properties": {
        "base_path": {
          "type": "string",
          "description": "Base URL path for RPC endpoints (e.g., '/rpc', '/api/rpc')",
          "pattern": "^/.*"
        },
        "service_name": {
          "type": "string",
          "description": "Name of the RPC service to mount"
        }
      },
      "additionalProperties": false
    }
  }
}